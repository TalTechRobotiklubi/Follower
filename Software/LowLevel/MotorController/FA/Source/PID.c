
//----------------------------------------------------------------------------------------------------------------------------
// INCLUDE FILES
//----------------------------------------------------------------------------------------------------------------------------
#include "PID.h"

//----------------------------------------------------------------------------------------------------------------------------
//	LOCAL DEFINITIONS AND CONSTANTS
//----------------------------------------------------------------------------------------------------------------------------
#define AT_SETPOINT     0
#define	AT_LIMIT		1

//----------------------------------------------------------------------------------------------------------------------------
//	LOCAL VARIABLES
//----------------------------------------------------------------------------------------------------------------------------
float fKf 				= 0;
float fKp 				= 0;
float fKi 				= 0;
float fKd 				= 0;
float fError			= 0;
float fPrevInput		= 0;
float fInputChange		= 0;
float fITerm			= 0;
float fTempOut			= 0;
uint32_t u32Timelevel   = 0;

//----------------------------------------------------------------------------------------------------------------------------
// LOCAL FUNCTION PROTOTYPES
//----------------------------------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------------------------------
// FUNCTIONS
//----------------------------------------------------------------------------------------------------------------------------

/*****************************************************************************************************************************
* See header file for detailed function description                                                                          *
*****************************************************************************************************************************/
void vPid(T_PID* ptPid)
{
	
	//------------------------------------------------------------------------------------------------------------------------
	//	If any of the parameters has changed
	//------------------------------------------------------------------------------------------------------------------------
	if((fKf != *ptPid->pfKf) || (fKp != *ptPid->pfKp) ||
			(fKi != *ptPid->pfKp) || (fKi != *ptPid->pfKp) ||
			(u32Timelevel != *ptPid->pu32Timelevel))
	{
		float fTimeLevelSec = *ptPid->pu32Timelevel/10000.0;

		fKf = *ptPid->pfKf;
		fKp = *ptPid->pfKp;
		fKi = *ptPid->pfKi * fTimeLevelSec;
		fKd = *ptPid->pfKd * fTimeLevelSec;
	}

	//------------------------------------------------------------------------------------------------------------------------
	//	Calculation of difference between actual value and setpoint e.g. error
	//------------------------------------------------------------------------------------------------------------------------
	fError = *ptPid->pfSetpoint - *ptPid->pfSpeedAct;
	
	//------------------------------------------------------------------------------------------------------------------------
	//	Error threshold. There is no need to correct very small errors. Integral term is reset
	//------------------------------------------------------------------------------------------------------------------------
	if((fError >= 0) && (fError < *ptPid->pfMinErr))
	{
		fError = 0;
        fITerm = 0;
	}
	if((fError <= 0) && (fError > -(*ptPid->pfMinErr)))
	{
		fError = 0;
        fITerm = 0;
	}
	
	fInputChange = *ptPid->pfSpeedAct - fPrevInput;

	//------------------------------------------------------------------------------------------------------------------------
	//	Calculation and limitation of integral term
	//------------------------------------------------------------------------------------------------------------------------
	fITerm	+= fKi * fError;
	if(fITerm < -*ptPid->pfOutLim)
	{
		fITerm = -*ptPid->pfOutLim;
	}
	else if(fITerm > *ptPid->pfOutLim)
	{
		fITerm = *ptPid->pfOutLim;
	}

	//------------------------------------------------------------------------------------------------------------------------
	//	Calculation and limitation of output
	//------------------------------------------------------------------------------------------------------------------------
	fTempOut  = fKp * fError;
	fTempOut += fITerm;
	fTempOut += fKd * fInputChange;

	if(fTempOut < -*ptPid->pfOutLim)
	{
		fTempOut = -*ptPid->pfOutLim;
	}
	else if(fTempOut > *ptPid->pfOutLim)
	{
		fTempOut = *ptPid->pfOutLim;
	}

	//------------------------------------------------------------------------------------------------------------------------
	//	Setting of outputs. Also remembering current speed for derivative calculation on next cycle.
	//------------------------------------------------------------------------------------------------------------------------
	ptPid->fPidOut = fTempOut;
        
	fPrevInput = *ptPid->pfSpeedAct;
}
